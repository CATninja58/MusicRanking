<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tier List</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      padding: 20px;
    }

    h1 {
      text-align: center;
    }

    .mode-buttons {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
      gap: 10px;
    }

    .mode-buttons button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }

    .tier-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .tier-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      border: 1px solid #ccc;
      background: white;
      min-height: 80px;
    }

    .tier-label {
      width: 50px;
      font-weight: bold;
      text-align: center;
    }

    .draggable-item {
      width: 60px;
      height: 60px;
      object-fit: cover;
      cursor: grab;
    }

    .draggable-song {
      padding: 5px 10px;
      background: #ddd;
      border-radius: 4px;
      margin-right: 10px;
      cursor: grab;
    }

    .hidden {
      display: none;
    }

    .album-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
    }

    .album-button {
      padding: 10px;
      background: white;
      border: 1px solid #ccc;
      cursor: pointer;
    }

    .search-bar {
      text-align: center;
      margin-bottom: 10px;
    }

    .search-bar input {
      padding: 5px;
      width: 60%;
    }
  </style>
</head>
<body>
  <h1>Tier List for <span id="artistName"></span></h1>

  <div class="mode-buttons">
    <button onclick="setMode('albums')">Rank Albums</button>
    <button onclick="setMode('albumSongs')">Rank Album Songs</button>
    <button onclick="setMode('allSongs')">Rank All Songs</button>
  </div>

  <div id="albumSelect" class="album-selector hidden"></div>
  <div id="songSearch" class="search-bar hidden">
    <input type="text" id="searchInput" placeholder="Search songs...">
  </div>

  <div class="tier-container" id="tierContainer"></div>

  <script>
    const tiers = ['S', 'A', 'B', 'C', 'D'];
    const tierContainer = document.getElementById('tierContainer');
    const artistData = JSON.parse(localStorage.getItem('currentArtistData'));
    const albumSelect = document.getElementById('albumSelect');
    const searchBar = document.getElementById('songSearch');
    const searchInput = document.getElementById('searchInput');
    const artistNameEl = document.getElementById('artistName');

    if (!artistData) {
      alert('No artist data found. Please go back and select an artist.');
      throw new Error("No artist data in localStorage.");
    }

    artistNameEl.textContent = artistData.name;

    let currentMode = 'albums'; // default
    let selectedAlbum = null;

    function initTierList(items, itemType) {
      tierContainer.innerHTML = '';
      tiers.forEach(tier => {
        const row = document.createElement('div');
        row.className = 'tier-row';
        row.dataset.tier = tier;
        row.ondrop = handleDrop;
        row.ondragover = e => e.preventDefault();

        const label = document.createElement('div');
        label.className = 'tier-label';
        label.textContent = tier;

        row.appendChild(label);
        tierContainer.appendChild(row);
      });

      items.forEach((item, i) => {
        let el;
        if (itemType === 'album') {
          el = document.createElement('img');
          el.src = item.cover;
          el.title = item.name;
          el.className = 'draggable-item';
        } else {
          el = document.createElement('div');
          el.textContent = item.name;
          el.className = 'draggable-song';
        }

        el.draggable = true;
        el.dataset.id = itemType === 'album' ? item.name : `${item.album}-${item.name}`;
        el.dataset.type = itemType;
        el.ondragstart = e => {
          e.dataTransfer.setData('text/plain', JSON.stringify({
            id: el.dataset.id,
            type: itemType,
            html: el.outerHTML
          }));
        };

        tierContainer.querySelector('[data-tier="D"]').appendChild(el);
      });

      loadSavedTierList();
    }

    function setMode(mode) {
      currentMode = mode;
      albumSelect.classList.add('hidden');
      searchBar.classList.add('hidden');

      if (mode === 'albums') {
        const albums = artistData.albums;
        initTierList(albums, 'album');
      } else if (mode === 'albumSongs') {
        albumSelect.innerHTML = '';
        artistData.albums.forEach(album => {
          const btn = document.createElement('button');
          btn.textContent = album.name;
          btn.className = 'album-button';
          btn.onclick = () => {
            selectedAlbum = album;
            initTierList(album.songs.map(s => ({...s, album: album.name})), 'song');
          };
          albumSelect.appendChild(btn);
        });
        albumSelect.classList.remove('hidden');
        tierContainer.innerHTML = '';
      } else if (mode === 'allSongs') {
        searchBar.classList.remove('hidden');
        const allSongs = artistData.albums.flatMap(album => 
          album.songs.map(song => ({...song, album: album.name}))
        );
        initTierList(allSongs, 'song');
      }
    }

    function handleDrop(e) {
      e.preventDefault();
      const data = JSON.parse(e.dataTransfer.getData('text/plain'));
      const dropZone = e.currentTarget;

      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = data.html;
      const draggedEl = tempDiv.firstChild;

      // avoid duplicates
      Array.from(tierContainer.querySelectorAll(`[data-id="${draggedEl.dataset.id}"]`)).forEach(el => el.remove());

      draggedEl.draggable = true;
      draggedEl.ondragstart = e => {
        e.dataTransfer.setData('text/plain', JSON.stringify({
          id: draggedEl.dataset.id,
          type: draggedEl.dataset.type,
          html: draggedEl.outerHTML
        }));
      };
      dropZone.appendChild(draggedEl);

      saveTierList();
    }

    function saveTierList() {
      const saved = {};
      tiers.forEach(tier => {
        const tierRow = tierContainer.querySelector(`[data-tier="${tier}"]`);
        saved[tier] = Array.from(tierRow.children)
          .filter(el => el.dataset && el.dataset.id)
          .map(el => el.dataset.id);
      });
      localStorage.setItem(`tierList_${artistData.name}_${currentMode}_${selectedAlbum?.name || ''}`, JSON.stringify(saved));
    }

    function loadSavedTierList() {
      const saved = JSON.parse(localStorage.getItem(`tierList_${artistData.name}_${currentMode}_${selectedAlbum?.name || ''}`));
      if (!saved) return;

      tiers.forEach(tier => {
        const row = tierContainer.querySelector(`[data-tier="${tier}"]`);
        saved[tier].forEach(id => {
          const allEls = tierContainer.querySelectorAll(`[data-id="${id}"]`);
          allEls.forEach(el => el.remove());
          const el = document.createElement('div');
          el.innerHTML = id.includes('-') ? id.split('-')[1] : id;
          if (id.includes('-')) {
            el.className = 'draggable-song';
          } else {
            el.className = 'draggable-item';
            el.style.background = '#ccc';
            el.style.width = '60px';
            el.style.height = '60px';
            el.textContent = id;
          }
          el.draggable = true;
          el.dataset.id = id;
          el.dataset.type = id.includes('-') ? 'song' : 'album';
          el.ondragstart = e => {
            e.dataTransfer.setData('text/plain', JSON.stringify({
              id: el.dataset.id,
              type: el.dataset.type,
              html: el.outerHTML
            }));
          };
          row.appendChild(el);
        });
      });
    }

    // Search for "All Songs" mode
    searchInput.addEventListener('input', () => {
      const term = searchInput.value.toLowerCase();
      document.querySelectorAll('.draggable-song').forEach(el => {
        el.style.display = el.textContent.toLowerCase().includes(term) ? 'inline-block' : 'none';
      });
    });

    setMode('albums');
  </script>
</body>
</html>
