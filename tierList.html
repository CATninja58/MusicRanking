<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Album Tier List</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1 {
      margin-bottom: 20px;
    }

    .tier-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
      width: 100%;
      max-width: 900px;
    }

    .tier {
      display: flex;
      align-items: center;
      background: #ddd;
      padding: 10px;
      border-radius: 10px;
    }

    .tier-label {
      width: 50px;
      font-weight: bold;
      font-size: 18px;
      margin-right: 10px;
    }

    .tier-dropzone {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      min-height: 80px;
      flex: 1;
      padding: 5px;
      background: #fff;
      border-radius: 8px;
    }

    .album-pool {
      margin-top: 30px;
      background: #eaeaea;
      padding: 10px;
      border-radius: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      max-width: 900px;
      justify-content: center;
    }

    .album {
      width: 100px;
      cursor: grab;
    }

    .album img {
      width: 100%;
      border-radius: 8px;
    }

    .album.dragging {
      opacity: 0.5;
    }
  </style>
</head>
<body>
  <h1 id="title">Loading artist...</h1>

  <div class="tier-list" id="tierList"></div>

  <h2>Albums</h2>
  <div class="album-pool" id="albumPool"></div>

  <script>
    const tiers = ["S", "A", "B", "C", "D"];

    function getQueryParam(param) {
      const params = new URLSearchParams(window.location.search);
      return params.get(param);
    }

    function saveTierList(artistName) {
      const tierData = {};
      tiers.forEach(tier => {
        const dropzone = document.querySelector(`.tier-dropzone[data-tier="${tier}"]`);
        tierData[tier] = Array.from(dropzone.children).map(div => div.dataset.albumId);
      });
      localStorage.setItem(`tierlist-${artistName}`, JSON.stringify(tierData));
    }

    function loadTierList(artistName) {
      const data = localStorage.getItem(`tierlist-${artistName}`);
      return data ? JSON.parse(data) : {};
    }

    function createTierRow(label) {
      const tier = document.createElement("div");
      tier.className = "tier";

      const labelEl = document.createElement("div");
      labelEl.className = "tier-label";
      labelEl.textContent = label;

      const dropzone = document.createElement("div");
      dropzone.className = "tier-dropzone";
      dropzone.dataset.tier = label;

      dropzone.addEventListener("dragover", e => e.preventDefault());
      dropzone.addEventListener("drop", e => {
        e.preventDefault();
        const id = e.dataTransfer.getData("text/plain");
        const album = document.getElementById(id);
        if (album) {
          dropzone.appendChild(album);
          saveTierList(currentArtist); // Save immediately
        }
      });

      tier.appendChild(labelEl);
      tier.appendChild(dropzone);
      return tier;
    }

    async function loadAlbums(artistName) {
      document.getElementById("title").textContent = `${artistName} â€“ Tier List`;

      const response = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(artistName)}&entity=album&limit=200`);
      const data = await response.json();

      const albums = data.results
        .filter(item =>
          item.collectionType === "Album" &&
          !item.collectionName.toLowerCase().includes("single") &&
          !item.collectionName.toLowerCase().includes("ep") &&
          !item.collectionName.toLowerCase().includes("deluxe") &&
          !item.collectionName.toLowerCase().includes("instrumental") &&
          !item.collectionName.toLowerCase().includes("karaoke")
        )
        .map(album => ({
          id: album.collectionId.toString(),
          name: album.collectionName,
          releaseDate: album.releaseDate,
          cover: album.artworkUrl100.replace("100x100bb", "150x150bb"),
        }));

      const unique = [];
      const seen = new Set();
      for (const album of albums) {
        if (!seen.has(album.name)) {
          unique.push(album);
          seen.add(album.name);
        }
      }

      unique.sort((a, b) => new Date(a.releaseDate) - new Date(b.releaseDate));

      const albumMap = {};
      unique.forEach(album => {
        albumMap[album.id] = album;
      });

      const saved = loadTierList(artistName);

      const pool = document.getElementById("albumPool");
      pool.innerHTML = "";

      unique.forEach((album, index) => {
        const div = document.createElement("div");
        div.className = "album";
        div.draggable = true;
        div.id = `album-${album.id}`;
        div.dataset.albumId = album.id;
        div.innerHTML = `<img src="${album.cover}" alt="${album.name}" title="${album.name}">`;

        div.addEventListener("dragstart", e => {
          div.classList.add("dragging");
          e.dataTransfer.setData("text/plain", div.id);
        });

        div.addEventListener("dragend", () => {
          div.classList.remove("dragging");
        });

        let placed = false;
        for (const [tier, ids] of Object.entries(saved)) {
          if (ids.includes(album.id)) {
            const dropzone = document.querySelector(`.tier-dropzone[data-tier="${tier}"]`);
            if (dropzone) {
              dropzone.appendChild(div);
              placed = true;
              break;
            }
          }
        }

        if (!placed) {
          pool.appendChild(div);
        }
      });
    }

    // Main execution
    const tierList = document.getElementById("tierList");
    tiers.forEach(t => {
      tierList.appendChild(createTierRow(t));
    });

    const currentArtist = getQueryParam("artist");
    if (currentArtist) {
      loadAlbums(currentArtist);
    } else {
      document.getElementById("title").textContent = "No artist specified in the URL.";
    }
  </script>

</body>
</html>
