<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tier List</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      padding: 20px;
    }

    h1 {
      text-align: center;
    }

    .mode-buttons {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
      gap: 10px;
    }

    .mode-buttons button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }

    .tier-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .tier-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      border: 1px solid #ccc;
      background: white;
      min-height: 80px;
    }

    .tier-label {
      width: 50px;
      font-weight: bold;
      text-align: center;
    }

    .draggable-item {
      width: 60px;
      height: 60px;
      object-fit: cover;
      cursor: grab;
    }

    .draggable-song {
      padding: 5px 10px;
      background: #ddd;
      border-radius: 4px;
      margin-right: 10px;
      cursor: grab;
    }

    .hidden {
      display: none;
    }

    .album-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
    }

    .album-button {
      padding: 10px;
      background: white;
      border: 1px solid #ccc;
      cursor: pointer;
    }

    .search-bar {
      text-align: center;
      margin-bottom: 10px;
    }

    .search-bar input {
      padding: 5px;
      width: 60%;
    }
  </style>
</head>
<body>
  <h1>Tier List for <span id="artistName"></span></h1>

  <div class="mode-buttons">
    <button onclick="setMode('albums')">Rank Albums</button>
    <button onclick="setMode('albumSongs')">Rank Album Songs</button>
    <button onclick="setMode('allSongs')">Rank All Songs</button>
  </div>

  <div id="albumSelect" class="album-selector hidden"></div>
  <div id="songSearch" class="search-bar hidden">
    <input type="text" id="searchInput" placeholder="Search songs...">
  </div>

  <div class="tier-container" id="tierContainer"></div>

  <script>
    const tiers = ['S', 'A', 'B', 'C', 'D'];
    const tierContainer = document.getElementById('tierContainer');
    const albumSelect = document.getElementById('albumSelect');
    const searchBar = document.getElementById('songSearch');
    const searchInput = document.getElementById('searchInput');
    const artistNameEl = document.getElementById('artistName');

    // Placeholder artist data; replace with actual data fetching logic
    const artistData = {
      name: "Sample Artist",
      albums: [
        {
          name: "Album 1",
          cover: "https://via.placeholder.com/60",
          songs: [
            { name: "Song A" },
            { name: "Song B" }
          ]
        },
        {
          name: "Album 2",
          cover: "https://via.placeholder.com/60",
          songs: [
            { name: "Song C" },
            { name: "Song D" }
          ]
        }
      ]
    };

    if (!artistData) {
      alert('No artist data found. Please go back and select an artist.');
      throw new Error("No artist data available.");
    }

    artistNameEl.textContent = artistData.name;

    let currentMode = 'albums'; // default
    let selectedAlbum = null;

    function initTierList(items, itemType) {
      tierContainer.innerHTML = '';
      tiers.forEach(tier => {
        const row = document.createElement('div');
        row.className = 'tier-row';
        row.dataset.tier = tier;
        row.addEventListener('dragover', e => e.preventDefault());
        row.addEventListener('drop', handleDrop);

        const label = document.createElement('div');
        label.className = 'tier-label';
        label.textContent = tier;

        row.appendChild(label);
        tierContainer.appendChild(row);
      });

      items.forEach(item => {
        let el;
        if (itemType === 'album') {
          el = document.createElement('img');
          el.src = item.cover;
          el.title = item.name;
          el.className = 'draggable-item';
        } else {
          el = document.createElement('div');
          el.textContent = item.name;
          el.className = 'draggable-song';
        }

        el.draggable = true;
        el.dataset.id = itemType === 'album' ? item.name : `${item.album}-${item.name}`;
        el.dataset.type = itemType;
        el.addEventListener('dragstart', e => {
          e.dataTransfer.setData('text/plain', el.dataset.id);
        });

        tierContainer.querySelector('[data-tier="D"]').appendChild(el);
      });

      loadSavedTierList();
    }

    function setMode(mode) {
      currentMode = mode;
      albumSelect.classList.add('hidden');
      searchBar.classList.add('hidden');
      selectedAlbum = null;

      if (mode === 'albums') {
        const albums = artistData.albums;
        initTierList(albums, 'album');
      } else if (mode === 'albumSongs') {
        albumSelect.innerHTML = '';
        artistData.albums.forEach(album => {
          const btn = document.createElement('button');
          btn.textContent = album.name;
          btn.className = 'album-button';
          btn.onclick = () => {
            selectedAlbum = album;
            initTierList(album.songs.map(s => ({ ...s, album: album.name })), 'song');
          };
          albumSelect.appendChild(btn);
        });
        albumSelect.classList.remove('hidden');
        tierContainer.innerHTML = '';
      } else if (mode === 'allSongs') {
        searchBar.classList.remove('hidden');
        const allSongs = artistData.albums.flatMap(album =>
          album.songs.map(song => ({ ...song, album: album.name }))
        );
        initTierList(allSongs, 'song');
      }
    }

    function handleDrop(e) {
      e.preventDefault();
      const id = e.dataTransfer.getData('text/plain');
      const draggedEl = document.querySelector(`[data-id="${id}"]`);
      const dropZone = e.currentTarget;

      if (draggedEl && dropZone) {
        dropZone.appendChild(draggedEl);
        saveTierList();
      }
    }

    function saveTierList() {
      const saved = {};
      tiers.forEach(tier => {
        const tierRow = tierContainer.querySelector(`[data-tier="${tier}"]`);
        saved[tier] = Array.from(tierRow.children)
          .filter(el => el.dataset && el.dataset.id)
          .map(el => el.dataset.id);
      });
      const key = `tierList_${artistData.name}_${currentMode}_${selectedAlbum?.name || ''}`;
      localStorage.setItem(key, JSON.stringify(saved));
    }

    function loadSavedTierList() {
      const key = `tierList_${artistData.name}_${currentMode}_${selectedAlbum?.name || ''}`;
      const saved = JSON.parse(localStorage.getItem(key));
      if (!saved) return;

      // Clear existing items
      tiers.forEach(tier => {
        const row = tierContainer.querySelector(`[data-tier="${tier}"]`);
        Array.from(row.children).forEach(child => {
          if (child.classList.contains('draggable-item') || child.classList.contains('draggable-song')) {
            row.removeChild(child);
          }
        });
      });

      // Re-add items based on saved data
      Object.entries(saved).forEach(([tier, ids]) => {
        const row = tierContainer.querySelector(`[data-tier="${tier}"]`);
        ids.forEach(id => {
          let el;
          if (id.includes('-')) {
            // Song
            const [albumName, songName] = id.split('-');
            el = document.createElement('div');
            el.textContent = songName;
            el.className = 'draggable-song';
            el.dataset.type = 'song';
          } else {
            // Album
            const album = artistData.albums.find(a => a.name === id);
            el = document.createElement('img');
            el.src = album ? album.cover : '';
            el.title = id;
            el.className = 'draggable-item';
            el.dataset.type = 'album';
          }
          el.draggable = true;
          el.dataset.id = id;
          el.addEventListener('dragstart', e => {
            e.dataTransfer.setData('text/plain', el.dataset.id);
          });
          row.appendChild(el);
        });
      });
    }

    // Search for "All Songs" mode
    searchInput.addEventListener('input', () => {
      const term = searchInput.value.toLowerCase();
      document.querySelectorAll('.draggable-song').forEach(el => {
        el.style.display = el.textContent.toLowerCase().includes(term) ? 'inline-block' : 'none';
      });
    });

    setMode('albums');
  </script>
</body>
</html>
